# Зміни в PON Monitor

## v2025.09.01 Поточна версія

> [!WARNING]
> **Критичне оновлення!** Ця версія істотно змінює структуру БД та не сумісна з попередніми версіями модулів вендорів. Обов'язково потрібно оновити модулі вендорів!

> [!CAUTION]
> Обов'язково потрібно виконати наступні дії:
 - зупиніть сервіс `nokernel.pl -m=ponmon`
 - запустіть `bin/upgrade.pl` для оновлення модуля.
 - видаліть з БД тригери:
```sql
USE nodeny;
DROP TRIGGER IF EXISTS `tr_aft_ins_pon`;
DROP TRIGGER IF EXISTS `tr_aft_upd_pon`;
```
 - перезапустіть процес моніторингу

### Важливі зміни
 - перероблено збереження даних графіків в БД з повною відмовою від тригерів, що дозволило покращити і розширити можливості модуля
 - додано можливість винести збереження даних графіків в окрему БД (таблиці не переносяться автоматично, тому їх потрібно перенести вручну)
 - об'єм даних графіків в БД зменшено за рахунок фільтрації змін (щоб не зберігати в БД одні і ті ж дані, останній зріз даних порівнюється з попереднім, і якщо вони однакові, то останній зріз для конкретної ONU не зберігається, але примусово зберігаються кожен 20-й зріз)
 - додано можливість запускати кожну OLT в окремому процесі, що не використовує систему керування процесами (Parallel::ForkManager), яка НЕ у всіх працює стабільно, або при недоступності 1 з ОЛТ весь моніторинг сильно уповільнювався. Для цього потрібно перемкнути запуск сканування OLT в режим "Самостійно", а в консолі виконати команду, наприклад для OLT з ID=1:
```bash
perl /usr/local/nodeny/_noponmon.pl -o=1 -vv
```
 - SNMP виклики тепер виконуються через системну програму, а не через Perl модуль Net::SNMP, що дозволило покращити швидкодію та якість отриманих даних
 - модулі вендорів перероблені з функціональних модулів на класи, для кращого розуміння та підтримки, та для зручності використання в інших модулях (наприклад, кастомні команди для ONU)

### Інші зміни

> [!TIP]
> Починаючи з цієї версії, вся документація буде перенесена в [GitHub Wiki](https://github.com/Mr-Method/Ponmon/wiki), після чого стару документацію буде видалено з моєї Wiki на [ndp.pp.ua](https://ndp.pp.ua).

## v2025.08.20_old

> [!TIP]
> В цій версії модуля зібрано важливі виправлення, оновлено інтерфейс, та структуру, але без критичних змін для сумісності з старими модулями вендорів.

### Важливі виправлення
 - виправлено проблему розміру таблиці pon_bind
 - виправлено проблему при відсутності поля _adr_place в додаткових полях (винесено в налаштування)
 - виправлено проблему з очищенням кешу FDB, старих прив'язок та графіків (перероблено в окремому модулі ядра)
 - виправлено проблему з вимкненям OLT в БД
 - замість шаблонів для OLT тепер використовуються персональні параметри
 - кардинально перероблено систему привязок ONU до абонента або ТКД (винесено в окремий AJAX інтерфейс)
 - додано файл `bin/upgrade.pl` для оновлення модуля

### Загальні зміни
 - веб-інтерфейс перероблено на використання окремих AJAX файлів
 - блок ONU в адмінці абонента перероблено на AJAX інтерфейс
 - додано пошук по ONU по гілці
 - додано сортування по певним колонкам в списку ONU
 - додано таблицю поточних статусів ONU з підрахунком кількості по статусах
 - додано файл `cpanfile` для майбутньої автоматизації або ручного встановлення залежностей
 - модуль доступний для завантаження з [GITHUB](https://github.com/Mr-Method/ponmon/releases)

 ### Інші зміни
- **Оновлено стиль написання**: оновлено стиль написання умовних конструкцій
- **Покращено читабельність**: додано пробіли та узгоджено форматування
- **Видалено застарілий код**: очищено від непотрібних коментарів та функцій
- **Додано файл `README.md`**: з основними інструкціями по використанню модуля
- **Додано файл `CHANGELOG.md`**: зі списком змін в модулі

## v2020.10.23

> [!TIP]
> Останнє оновлення модуля, який було інтегровано в комплект поставки NoDeny Next.

### Технічні зміни
 - переведено `create.kernel.ponmon.pm` на використання `Parallel::ForkManager` замість потоків
 - покращено обробку OLT через управління процесами
 - додано нові функції для очищення історії графіків
 - внесено зміни в SQL запити для таблиць `pon_fdb` та `pon_olt`, включаючи нові поля
 - в `create.web.ponmon.pl` додано відображення графіків та інформації про OLT
 - в `create.o_pon_olt.pl` виправлено SQL запит для отримання даних
 - додано новий файл `create.web.ajOnuMenu.pl` для виконання кастомних команд
 - додано нові поля `pon_type` та `mng_tmpl` до таблиці `pon_olt`
 - видалено старі поля `mng_user`, `mng_pswd` та `mng_type`
 - внесено покращення в обробку помилок та виведення даних

## v2020.08.29

### Технічні зміни
 - додано обробку часу для графіків у `create.ajOnuGraph.pl`
 - оновлено SQL запити для таблиць у `create.kernel.ponmon.pm`
 - змінено логіку відображення даних у `create.web.ponmon.pl`
 - додано нову функцію `Get_list_of_stat_days`
 - внесено зміни в HTML шаблони для покращення відображення графіків
 - оновлено структуру таблиць у `sql.pon_fdb.txt` та `sql.pon_olt.txt`
 - додано відображення часу останньої зміни для OLT у `create.web.ponmon.pl`

## v2020.06.09

### Технічні зміни
 - виправлено обробку введення для 'bid' у `create.ajOnuGraph.pl`, замінено на `ses::input_int`
 - у `create.kernel.ponmon.pm` додано перевірку доступності OLT перед створенням потоків, оновлено логіку обробки статусу OLT
 - у `create.web.ponmon.pl` додано відображення часу останньої зміни для OLT
 - у `patch.user.pl` додано поле 'mac' до SQL запиту
 - в `sql.pon_bind.txt` змінено статус на NULL за замовчуванням

## v2020.04.13

### Технічні зміни
 - додано нові поля `pon_type` та `mng_tmpl` до таблиці `pon_olt`
 - оновлено SQL запити для отримання даних з бази
 - внесено зміни в обробку модуля OLT
 - видалено старі поля `mng_user`, `mng_pswd` та `mng_type`
 - внесено покращення в обробку помилок та виведення даних

## v2020.03.21

> [!TIP]
> Перший випуск модуля інтегровано в комплект поставки NoDeny Next.
