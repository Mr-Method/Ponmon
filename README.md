# Модуль PON Monitor (Ponmon)

Модуль моніторингу PON обладнання для білінгової системи [NoDeny Next](https://nodeny.com.ua/).

> [!CAUTION]
> На момент написання документації даний модуль інтегрований в комплект поставки NoDeny Next ( ревізія 715 ), і встановлювати цю версію не можна (вона не встановиться, ще й може пошкодити існуючу БД).

> [!WARNING]  
> Для встановлення даної версії модуля, потрібно використовувати майбутню ревізію NoDeny Next (повідомлю тут і на форуміпісля виходу).

## Огляд

Ponmon - це комплексний модуль для моніторингу PON (Passive Optical Network) обладнання, разом з модулями вендорів OLT, які забезпечують:
- Моніторинг OLT та ONU
- Збір статистики потужності сигналу (RX/TX)
- Збір даних FDB для перегляду MAC-адрес за ONU
- Веб-інтерфейс для перегляду та управління обладнанням
- Автоматичне очищення застарілих даних в БД

## Модулі вендорів OLT

Модулі вендорів OLT купуються окремо в [кабінеті](https://app.nodeny-plus.com.ua/cgi-bin/stat.pl).
Наразі доступні модулі вендорів:
- ZTE
  - C220 (GPON/EPON)
  - C300 (GPON/EPON)
  - C320 (GPON/EPON)
- BDCOM
  - P3310B (EPON)
  - P3310C (EPON)
  - P3310D (EPON)
  - P3608 (GPON)
  - P3616-2TE (GPON)
- STELS/C-DATA
  - Stels FD1108SN (EPON)
- V-Solutions
  - V1600D8 (EPON)

## Термінологія
- OLT (Optical Line Terminal) - це оптичний термінал, який забезпечує з'єднання через оптичне волокно до ONU.
- ONU (Optical Network Unit) - це оптичний мережевий пристрій, який забезпечує з'єднання через оптичне волокно до кінцевого користувача.
- FDB (Forwarding Database) - це база даних, яка містить інформацію про MAC-адреси за ONU.
- RX (Receive) - це сила сигналу прийому (dBm).
- TX (Transmit) - це сила сигналу передачі (dBm).
  

## Таблиці БД
Модуль використовує наступні таблиці:
- `pon_olt` - конфігурація OLT
- `pon_onu` - інформація про ONU
- `pon_bind` - прив'язки ONU до портів
- `pon_fdb` - FDB кеш
- `pon_mon` - тимчасові дані моніторингу
- `z{YYYY}_{MM}_{DD}_pon` - архівні дані по днях для графіків

## Встановлення

### Завантаження

Завантажити модуль вручну:
- з репозиторію [https://github.com/Mr-Method/Ponmon/releases](https://github.com/Mr-Method/Ponmon/releases)

Завантажений архів розпакуйте в директорію `/usr/local/nodeny/modules/Ponmon`.

Завантажити модуль останньої версії з репозиторію через `git`: (рекомендовано)
```bash
cd /usr/local/nodeny/modules/
git clone https://github.com/Mr-Method/Ponmon ./Ponmon
```

Або можна завантажити версію по тегу з `git`: (для сумісності з старими модулями вендорів)
```bash
cd /usr/local/nodeny/modules/
git clone -b v2025.08.20_old https://github.com/Mr-Method/Ponmon ./Ponmon
```

### Залежності
```bash
# Встановлення Perl модулів
cd /usr/local/nodeny/modules/Ponmon/
cpanm --installdeps .
```

Потрібні модулі:
- Parallel::ForkManager >= 2.02
- Net::Telnet::Cisco >= 1.12
- Net::SNMP >= 6.0.1
- Net::SNMP::Util >= 1.04

### Інсталяція

```bash
# Встановлення Perl модулів
cd /usr/local/nodeny/
perl install.pl -x
perl install.pl -w=www
```

### Оновлення

> [!WARNING]  
> Після встановлення нової версії модуля, потрібно разово оновити структуру БД. Повторне запуск оновлення просто перевірить правильність структури БД.

Що буде змінено:
 - оновлення таблиці `pon_olt` для використання параметрів замість шаблонів
 - оновлення таблиці `pon_onu` для прив'язки до абонента або ТКД
 - оновлення таблиці `pon_bind` для запису дерева ONU
 - оновлення таблиці `pon_fdb`
 - конвертація таблиці параметрів з шаблонів на параметри

Перед оновленням:
 - зупинити модуль `ponmon` (якщо він запущений)
 - бажано зробити резервну копію таблиці `pon_olt`
 - запустити оновлення структури БД:
```bash
# Оновлення структури БД
perl /usr/local/nodeny/modules/Ponmon/bin/upgrade.pl
```

Після оновлення, можете переглянути налаштування через веб-інтерфейс:
 - `Налаштування -> Модулі -> PON-Monitor`
 - `Налаштування -> Ядро -> Моніторинг PON`
 - `Налаштування -> OLT Сервера`

## Запуск моніторингу
Модуль не рекомендується запускати як частина ядра NoDeny, бо він може завантажуватися дуже довго і впливати на роботу інших модулів.

Модуль бажано запускати як окремий процес:
```bash
cd /usr/local/nodeny/
# Запуск одноразово (для тестування)
perl nokrnel.pl -m=ponmon -vv

# Запуск в режимі демона
perl nokrnel.pl -m=ponmon -d &
```
